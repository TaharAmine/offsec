--
-- xp_cmdshell - statements to enable/disable xp_cmdshell on SQL Server
--

-- Show whether xp_cmdshell is enabled
SELECT CONVERT(INT, ISNULL(value, value_in_use)) AS xp_cmdshell_is_enabled
FROM  sys.configurations
WHERE  name = N'xp_cmdshell' ;

-- Enable Change in Advanced Options
EXEC SP_CONFIGURE N'show advanced options', 1
GO
RECONFIGURE
GO
-- Enable XP_cmdshellEXEC 
EXEC SP_CONFIGURE N'xp_cmdshell', 1
GO
RECONFIGURE
GO
-- Disable Changes in Advanced Options
EXEC SP_CONFIGURE N'show advanced options', 0
GO
RECONFIGURE
GO

--Show whether xp_cmdshell is enabled
SELECT CONVERT(INT, ISNULL(value, value_in_use)) AS xp_cmdshell_is_enabled
FROM  sys.configurations
WHERE  name = N'xp_cmdshell' ;


--
-- SQL Server service and agent user - shows the user that the service is running as
--

DECLARE       @DBEngineLogin       VARCHAR(100)
DECLARE       @AgentLogin          VARCHAR(100)
 
EXECUTE       master.dbo.xp_instance_regread
              @rootkey      = N'HKEY_LOCAL_MACHINE',
              @key          = N'SYSTEM\CurrentControlSet\Services\MSSQLServer',
              @value_name   = N'ObjectName',
              @value        = @DBEngineLogin OUTPUT
 
EXECUTE       master.dbo.xp_instance_regread
              @rootkey      = N'HKEY_LOCAL_MACHINE',
              @key          = N'SYSTEM\CurrentControlSet\Services\SQLServerAgent',
              @value_name   = N'ObjectName',
              @value        = @AgentLogin OUTPUT
 
SELECT        [DBEngineLogin] = @DBEngineLogin, [AgentLogin] = @AgentLogin
GO


--
-- Example commands
--

-- add user
xp_cmdshell 'net user /add test_user x2$5sjlw678!'

-- add user to administrators group
xp_cmdshell 'net localgroup administrators test_user /add'

-- get server hostname
xp_cmdshell 'hostname'